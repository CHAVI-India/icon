{% extends "app/base.html" %}
{% load static %}

{% block title %}Upload Training Data{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2>Upload Training Data Archive</h2>
            <p class="text-muted">Upload a ZIP archive containing DICOM training data files</p>
        </div>
    </div>

    {% if messages %}
    <div class="row mb-3">
        <div class="col-md-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h5>Upload Archive</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="training_data_file" class="form-label">Select ZIP Archive</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="training_data_file" 
                                   name="training_data_file" 
                                   accept=".zip"
                                   required>
                            <div class="form-text">Only ZIP files are accepted. The archive should contain DICOM files (CT/MR/PT images, RTStructureSets, RTPlan, and RTDose files).</div>
                        </div>

                        <div class="mb-3" id="fileInfo" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Selected File:</strong> <span id="fileName"></span><br>
                                <strong>Size:</strong> <span id="fileSize"></span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="bi bi-upload"></i> Upload Archive
                            </button>
                            <a href="{% url 'trainer:training_data_list' %}" class="btn btn-secondary">
                                <i class="bi bi-list"></i> View Uploaded Archives
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5>Archive Requirements</h5>
                </div>
                <div class="card-body">
                    <h6>Supported DICOM Modalities:</h6>
                    <ul>
                        <li><strong>Image Files:</strong> CT, MR, PT</li>
                        <li><strong>RT Structure Sets:</strong> RTSTRUCT</li>
                        <li><strong>RT Plans:</strong> RTPLAN</li>
                        <li><strong>RT Dose:</strong> RTDOSE</li>
                    </ul>
                    
                    <h6 class="mt-3">Processing Steps:</h6>
                    <ol>
                        <li>Upload your ZIP archive containing DICOM files</li>
                        <li>Navigate to the "Uploaded Archives" page</li>
                        <li>Click "Process Archive" to extract and organize the data</li>
                        <li>Monitor the progress bar for real-time updates</li>
                        <li>Files will be organized by Series Instance UID with proper structure</li>
                    </ol>

                    <div class="alert alert-warning mt-3">
                        <strong>Note:</strong> The archive can contain files in nested subdirectories. All DICOM files will be automatically discovered and processed.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('training_data_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');

    fileInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            fileName.textContent = file.name;
            
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            fileSize.textContent = sizeInMB + ' MB';
            
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    });

    uploadForm.addEventListener('submit', function(e) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    });
});
</script>

{% endblock %}
